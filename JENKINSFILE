pipeline {
        agent any
        
        stages {
            stage('Get Code'){
                steps {
                    //Obtener codigo del repo
                git url: 'https://github.com/cudi08/helloworld.git',
                    branch: 'main'
                }
            }
            stage('Build'){
                steps {
                    echo 'NO COMPILAMOS NADA'
                    echo WORKSPACE
                    sh 'ls -la'
                }
            }
            stage('Tests') {
                parallel {
                    stage('Unit'){
                        steps {
                            catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE'){
                                sh '''
                                export PYTHONPATH=$WORKSPACE
                                pytest --junitxml=result-unit.xml test/unit
                                '''
                            }
                            
                        }
                    }
                    stage('Rest'){
                        steps {
                            sh '''
                                export PYTHONPATH=$WORKSPACE
                                export FLASK_APP=app/api.py
                                flask run&
                                java -jar wiremock-standalone-3.13.2.jar --port=9090 --root-dir test/wiremock &
                                pytest --junitxml=result-rest.xml test/rest
                            '''
                        }
                    }
                }
            }
            stage('Results'){
                steps {
                    junit 'result*.xml'
                }
            }
        }
}
